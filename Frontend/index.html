<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Coupon System</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background-color: #f0f0f0; text-align: center; }
    h1 { color: #333; }
    .selection-container, .login-container, .button-container { display: flex; flex-wrap: wrap; justify-content: center; }
    input, button { margin: 5px; padding: 10px 20px; font-size: 16px; border-radius: 5px; }
    input { width: 200px; }
    button { background-color: #4CAF50; color: white; border: none; cursor: pointer; }
    button:hover { background-color: #45a049; }
    #result { margin-top: 20px; padding: 10px; background-color: #fff; border: 1px solid #ccc; border-radius: 5px; text-align: left; word-wrap: break-word; max-width: 90%; margin-left: auto; margin-right: auto; }
    .section { display: none; }
    .tab-button { margin: 5px; padding: 10px; background-color: #ddd; border: none; cursor: pointer; }
    .tab-button.active { background-color: #4CAF50; color: white; }
    @media (max-width: 600px) { input, button, .tab-button { width: 100%; margin: 5px 0; } #result { font-size: 14px; } }
  </style>
</head>
<body>
  <h1>Coupon System</h1>
  <div id="selectionSection" class="selection-container">
    <button onclick="showSection('shopkeeper')">Shopkeeper</button>
    <button onclick="showSection('customer')">Customer</button>
  </div>
  
  <!-- Shopkeeper Interface -->
  <div id="shopkeeperSection" class="section">
    <div class="selection-container">
      <button class="tab-button active" onclick="showShopkeeperTab('create')">Create Account</button>
      <button class="tab-button" onclick="showShopkeeperTab('login')">Login</button>
    </div>
    <!-- Create Account Tab -->
    <div id="shopkeeperCreate" class="login-container">
      <input id="shopkeeperName" placeholder="Name" required>
      <input id="shopkeeperEmail" type="email" placeholder="Email" required>
      <input id="shopkeeperId" placeholder="Shopkeeper ID (e.g., c4815927-d88f-46ac-b3d8-5e4c1beaabcc)" required>
      <input id="shopkeeperPhone" placeholder="Phone Number" required>
      <input id="shopkeeperPassword" type="password" placeholder="Password" required>
      <button onclick="shopkeeperCreateAccount()">Create Account</button>
    </div>
    <!-- Login Tab -->
    <div id="shopkeeperLogin" class="login-container" style="display: none;">
      <input id="shopkeeperLoginEmail" type="email" placeholder="Email" required>
      <input id="shopkeeperLoginId" placeholder="Shopkeeper ID" required>
      <input id="shopkeeperLoginPassword" type="password" placeholder="Password" required>
      <button onclick="shopkeeperLogin()">Login</button>
    </div>
    <div id="shopkeeperDashboard" class="button-container" style="display: none;">
      <button onclick="createCoupon('shopkeeper')">Create Coupon</button>
      <button onclick="createShareLink('shopkeeper')">Generate Share Link</button>
      <button onclick="addClicks('shopkeeper')">Simulate 3 Clicks</button>
      <button onclick="viewRedemptions('shopkeeper')">View Redemptions</button>
      <button onclick="autoRedeem('shopkeeper')">Auto Redeem</button>
    </div>
  </div>

  <!-- Customer Login and Dashboard -->
  <div id="customerSection" class="section">
    <div id="customerLogin" class="login-container">
      <input id="customerName" placeholder="Your Name" required>
      <input id="customerEmail" type="email" placeholder="Your Email" required>
      <input id="customerPhone" placeholder="Phone Number" required>
      <input id="customerShopkeeperId" placeholder="Shopkeeper ID" required>
      <button onclick="customerCreateOrLogin()">Create/Login</button>
    </div>
    <div id="customerDashboard" class="button-container" style="display: none;">
      <button onclick="createCoupon('customer')">Create Coupon</button>
      <button onclick="viewShareLink('customer')">View Share Link</button>
    </div>
  </div>

  <p id="result"></p>

  <script>
    function isValidUUID(uuid) {
      const uuidRegex = /^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/;
      return uuidRegex.test(uuid);
    }

    function showSection(role) {
      document.getElementById('selectionSection').style.display = 'none';
      if (role === 'shopkeeper') {
        document.getElementById('shopkeeperSection').style.display = 'block';
        showShopkeeperTab('create'); // Default to create tab
      } else if (role === 'customer') {
        document.getElementById('customerSection').style.display = 'block';
      }
    }

    function showShopkeeperTab(tab) {
      const tabs = ['create', 'login'];
      tabs.forEach(t => {
        document.getElementById(`shopkeeper${t.charAt(0).toUpperCase() + t.slice(1)}`).style.display = t === tab ? 'block' : 'none';
        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.toggle('active', btn.textContent.toLowerCase() === tab));
      });
    }

    // Shopkeeper Create Account
    let shopkeeperId = localStorage.getItem('shopkeeperId') || null;
    async function shopkeeperCreateAccount() {
      const name = document.getElementById('shopkeeperName').value;
      const email = document.getElementById('shopkeeperEmail').value;
      const phone = document.getElementById('shopkeeperPhone').value;
      const shopkeeperIdInput = document.getElementById('shopkeeperId').value.toLowerCase();
      const password = document.getElementById('shopkeeperPassword').value;
      if (!name || !email || !phone || !shopkeeperIdInput || !password) {
        document.getElementById('result').innerText = 'Please fill all fields!';
        return;
      }
      if (!isValidUUID(shopkeeperIdInput)) {
        document.getElementById('result').innerText = 'Invalid Shopkeeper ID format!';
        return;
      }
      const response = await fetch('http://localhost:3000/api/users', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, email, phone_number: phone, role: 'shopkeeper', password_hash: password })
      });
      const data = await response.json();
      if (response.ok) {
        shopkeeperId = data.id;
        localStorage.setItem('shopkeeperId', shopkeeperId);
        document.getElementById('shopkeeperCreate').style.display = 'none';
        document.getElementById('shopkeeperDashboard').style.display = 'flex';
        document.getElementById('result').innerText = `Account created and logged in as ${name}! Shopkeeper ID: ${shopkeeperId}`;
      } else if (data.error && data.error.includes('already exists')) {
        document.getElementById('result').innerText = 'User with this email already exists! Try logging in.';
      } else {
        document.getElementById('result').innerText = JSON.stringify(data, null, 2);
      }
    }

    // Shopkeeper Login
    async function shopkeeperLogin() {
      const email = document.getElementById('shopkeeperLoginEmail').value;
      const shopkeeperIdInput = document.getElementById('shopkeeperLoginId').value.toLowerCase();
      const password = document.getElementById('shopkeeperLoginPassword').value;
      if (!email || !shopkeeperIdInput || !password) {
        document.getElementById('result').innerText = 'Please fill all fields!';
        return;
      }
      if (!isValidUUID(shopkeeperIdInput)) {
        document.getElementById('result').innerText = 'Invalid Shopkeeper ID format!';
        return;
      }
      const response = await fetch('http://localhost:3000/api/users/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, shopkeeper_id: shopkeeperIdInput, password })
      });
      const data = await response.json();
      if (response.ok) {
        shopkeeperId = data.id;
        localStorage.setItem('shopkeeperId', shopkeeperId);
        document.getElementById('shopkeeperLogin').style.display = 'none';
        document.getElementById('shopkeeperDashboard').style.display = 'flex';
        document.getElementById('result').innerText = `Logged in as ${data.name}! Shopkeeper ID: ${shopkeeperId}`;
      } else {
        document.getElementById('result').innerText = 'Invalid credentials! Please check email, ID, or password.';
      }
    }

    async function createCoupon(role) {
      if (role === 'shopkeeper' && !shopkeeperId) {
        document.getElementById('result').innerText = 'Please log in first!';
        return;
      }
      const userId = role === 'shopkeeper' ? shopkeeperId : localStorage.getItem('customerId');
      let shopId;
      if (role === 'shopkeeper') {
        const shops = await fetch(`http://localhost:3000/api/shops?owner_id=${userId}`, {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' }
        }).then(res => res.json()).catch(err => { console.error('Shop fetch error:', err); return []; });
        shopId = shops.length > 0 ? shops[0].id : (await fetch('http://localhost:3000/api/shops', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name: `Shop_${userId}`, owner_id: userId })
        }).then(res => res.json()).then(data => data.id).catch(err => { console.error('Shop creation error:', err); return uuidv4(); }));
      } else {
        const shopkeeperIdInput = document.getElementById('customerShopkeeperId').value.toLowerCase();
        const shops = await fetch(`http://localhost:3000/api/shops?owner_id=${shopkeeperIdInput}`, {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' }
        }).then(res => res.json()).catch(err => { console.error('Shop fetch error:', err); return []; });
        shopId = shops.length > 0 ? shops[0].id : shopkeeperIdInput; // Fallback to input if no shop
      }
      const response = await fetch('http://localhost:3000/api/coupons', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          user_id: userId.toLowerCase(),
          shop_id: shopId.toLowerCase(),
          expires_at: '2025-12-31T23:59:59Z'
        })
      });
      const data = await response.json();
      if (response.ok) {
        localStorage.setItem(`${role}CouponId`, data.id);
        document.getElementById('result').innerText = `Coupon created! ID: ${data.id}. ${role === 'shopkeeper' ? 'Generate a share link next.' : 'View your share link.'}`;
      } else {
        document.getElementById('result').innerText = JSON.stringify(data, null, 2);
      }
    }

    async function createShareLink(role) {
      if (role !== 'shopkeeper' || !shopkeeperId) {
        document.getElementById('result').innerText = 'Only shopkeepers can generate share links or please log in first!';
        return;
      }
      const couponId = localStorage.getItem('shopkeeperCouponId');
      if (!couponId) {
        document.getElementById('result').innerText = 'Please create a coupon first!';
        return;
      }
      const response = await fetch('http://localhost:3000/api/share-links', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ coupon_id: couponId.toLowerCase() })
      });
      const data = await response.json();
      if (response.ok) {
        localStorage.setItem('shopkeeperShareLinkId', data.id);
        document.getElementById('result').innerText = `Share Link Generated! URL: ${data.link_url}. Share this with customers.`;
      } else {
        document.getElementById('result').innerText = JSON.stringify(data, null, 2);
      }
    }

    async function addClicks(role) {
      if (role !== 'shopkeeper' || !shopkeeperId) {
        document.getElementById('result').innerText = 'Only shopkeepers can simulate clicks or please log in first!';
        return;
      }
      const shareLinkId = localStorage.getItem('shopkeeperShareLinkId');
      if (!shareLinkId) {
        document.getElementById('result').innerText = 'Please generate a share link first!';
        return;
      }
      let results = '';
      for (let i = 0; i < 3; i++) {
        const response = await fetch('http://localhost:3000/api/clicks', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            share_link_id: shareLinkId.toLowerCase(),
            clicker_id: '5600a3db-3f20-4f5a-9e3d-c65c9747f988'.toLowerCase(),
            clicker_ip: '192.168.1.1'
          })
        });
        const data = await response.json();
        results += `Click ${i + 1}: ${JSON.stringify(data, null, 2)}\n`;
      }
      document.getElementById('result').innerText = results;
    }

    async function viewRedemptions(role) {
      if (role !== 'shopkeeper' || !shopkeeperId) {
        document.getElementById('result').innerText = 'Only shopkeepers can view redemptions or please log in first!';
        return;
      }
      const response = await fetch(`http://localhost:3000/api/redeem?shopkeeper_id=${shopkeeperId}`, {
        method: 'GET',
        headers: { 'Content-Type': 'application/json' }
      });
      const data = await response.json();
      if (response.ok) {
        document.getElementById('result').innerText = `Redemptions for Shopkeeper ${shopkeeperId}:\n${JSON.stringify(data, null, 2)}`;
      } else {
        document.getElementById('result').innerText = JSON.stringify(data, null, 2);
      }
    }

    async function autoRedeem(role) {
      if (role !== 'shopkeeper' || !shopkeeperId) {
        document.getElementById('result').innerText = 'Only shopkeepers can redeem or please log in first!';
        return;
      }
      const couponId = localStorage.getItem('shopkeeperCouponId');
      if (!couponId) {
        document.getElementById('result').innerText = 'Please create a coupon first!';
        return;
      }
      const response = await fetch('http://localhost:3000/api/redeem', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          coupon_id: couponId.toLowerCase(),
          redeemer_id: '5600a3db-3f20-4f5a-9e3d-c65c9747f988'.toLowerCase(),
          shopkeeper_id: shopkeeperId.toLowerCase()
        })
      });
      const data = await response.json();
      if (response.ok) {
        document.getElementById('result').innerText = `Redemption created: ${JSON.stringify(data, null, 2)}`;
        viewRedemptions(role); // Refresh redemptions view
      } else {
        document.getElementById('result').innerText = JSON.stringify(data, null, 2);
      }
    }

    // Customer Create/Login and Actions
    let customerId = localStorage.getItem('customerId') || null;
    async function customerCreateOrLogin() {
      const name = document.getElementById('customerName').value;
      const email = document.getElementById('customerEmail').value;
      const phone = document.getElementById('customerPhone').value;
      const shopkeeperIdInput = document.getElementById('customerShopkeeperId').value.toLowerCase();
      if (!name || !email || !phone || !shopkeeperIdInput) {
        document.getElementById('result').innerText = 'Please fill all fields!';
        return;
      }
      if (!isValidUUID(shopkeeperIdInput)) {
        document.getElementById('result').innerText = 'Invalid Shopkeeper ID format!';
        return;
      }
      const response = await fetch('http://localhost:3000/api/users', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, email, phone_number: phone, role: 'customer', password_hash: 'temp' })
      });
      const data = await response.json();
      if (response.ok) {
        customerId = data.id;
        localStorage.setItem('customerId', customerId);
        document.getElementById('customerLogin').style.display = 'none';
        document.getElementById('customerDashboard').style.display = 'flex';
        document.getElementById('result').innerText = `Created/Logged in as ${name}! Customer ID: ${customerId}`;
      } else {
        document.getElementById('result').innerText = JSON.stringify(data, null, 2);
      }
    }

    async function viewShareLink(role) {
      if (role !== 'customer' || !customerId) {
        document.getElementById('result').innerText = 'Only customers can view share links or please log in first!';
        return;
      }
      const couponId = localStorage.getItem('customerCouponId');
      if (!couponId) {
        document.getElementById('result').innerText = 'Please create a coupon first!';
        return;
      }
      const response = await fetch('http://localhost:3000/api/share-links', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ coupon_id: couponId.toLowerCase(), user_id: customerId })
      });
      const data = await response.json();
      if (response.ok) {
        document.getElementById('result').innerText = `Share Link Generated! URL: ${data.link_url}. Share this with friends.`;
      } else {
        document.getElementById('result').innerText = JSON.stringify(data, null, 2);
      }
    }
  </script>
</body>
</html>